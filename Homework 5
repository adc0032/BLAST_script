module load blast+

#Copy all fasta files from appropraite folders to the directly that you are working in.
#If copying and entire directory, use `-R` to copy the directory over 
#To see what the file endings mean, look at the read me in the genomes unzipped file
less /apps/bio/unzipped/genomes/Arabidopsis_thaliana/README
        
#Create a symbolic link to the path: 
ln -s /apps/bio/unzipped/genomes/Arabidopsis_thaliana/

#Building Databases
makeblastdb -in ATmt.fasta -dbtype nuc

#Choosing an out format (blastn -query test.fasta -db ATmt.fasta -outfmt [test type #] | less)
#We chose output format 7 which is tabular with comments
blastn -query test.fasta -db ATmt.fasta -outfmt 7 | less

#Databases Containing Multiple Fasta Files
#Formatting:-db "database 1" "database2" "database3"`       
#We combined the ATcp ATmt and ATcrhV fasta files to one database and the Arabidopsis CHR1 CHR2 and CHR3 into blast with the test.fasta query, output in the tab with comments format
blastn -db "ATmt.fasta ATcp.fasta ATchrV.fasta Arabidopsis_thaliana/CHR_I/NC_003070.gbk Arabidopsis_thaliana/CHR_II/NC_003071.gbk Arabidopsis_thaliana/CHR_III/NC_003074.gbk" -query test.fasta -outfmt 7 | less -S

##Limiting Output
#Limit to one hit per query, and limit the e value using -evalue and -max_target_seqs
blastn -db "ATmt.fasta ATcp.fasta ATchrV.fasta Arabidopsis_thaliana/CHR_I/NC_003070.gbk Arabidopsis_thaliana/CHR_II/NC_003071.gbk Arabidopsis_thaliana/CHR_III/NC_003074.gbk" -query test.fasta -outfmt 7 -evalue 0.00001 -max_target_seqs 1 | less -S

#Counting Sequence Output by adding the egrep -v option and using sed and awk to parse the data, placing the output into a file called RawCounts.txt
blastn -db "ATmt.fasta ATcp.fasta ATchrV.fasta Arabidopsis_thaliana/CHR_I/NC_003070.gbk Arabidopsis_thaliana/CHR_II/NC_003071.gbk Arabidopsis_thaliana/CHR_III/NC_003074.gbk" -query test.fasta -outfmt 7 -evalue 0.00001 -max_target-seqs 1| egrep -v '^#'| sed 's/[[:space:]]1_\/home.*NC_[0-9]*[[:space:]]/\tNT\t/'| awk '{print $1,$2}' | sort | uniq | awk '{print $2}' | sort | uniq -c | sort -n > RawCounts.txt

#Note: We dropped one cause we got 578 in the count not 579       
#Finding "Dropped" sequences (No Hits)
#The above code combined was set to a variable NUM and then instead of using egrep, grep c was used to match "0 hits", and NUM was appended to the RawCounts.txt file
NUM=$(blastn -db "ATmt.fasta ATcp.fasta ATchrV.fasta Arabidopsis_thaliana/CHR_I/NC_003070.gbk Arabidopsis_thaliana/CHR_II/NC_003071.gbk Arabidopsis_thaliana/CHR_III/NC_003074.gbk" -query test.fasta -outfmt 7 -evalue 0.00001 -max_target-seqs 1 | grep -c ' 0 hits ' ) && echo No_hits $NUM >> RawCounts.txt
